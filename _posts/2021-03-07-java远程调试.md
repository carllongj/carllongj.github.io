## 背景
   自己在做请求的拦截处理的时候处理有点问题,但不知道问题是出在哪里,问题没有办法跟踪,所以尝试了两种方式.其中,java web程序是布置在linux服务器上,并且有nginx作为服务器代理. 

## 解决方案  
1.  通过抓包查看请求数据.
2.  通过远程调试来debug查看对象中的数据.

### 抓包查看请求的数据
1. 在linux上,使用了tcpdump这个工具,简单说一下这个工具的使用
2. tcpdump -i 来指定接口,接口是通过ifconfig命令可以查看网卡接口,所以这个地方使用连接网络的接口,我的机器是eth0
3. 指定协议,tcpdump没有http协议,所以,可以指定下一层的tcp协议,来减少非必要数据抓取
   * 命令为  tcpdump -i eth0 tcp
4. nginx代理的是机器的80接口,所以,可以抓取80端口的数据包,通过 port 来指定端口
   * 命令为  `tcpdump -i eth0 tcp port 80`
5. 还有一个选项是针对文本数据有用的,-A 內容会以 ASCII 显示,http请求和响应中的大部分数据都会以文本形式显示
   * 命令为  `tcpdump -i eth0 tcp port 80 -A`
6. 注:由于存在nginx代理,抓取nginx代理到本地tomcat端口的网卡接口并不是eth0网卡,而是lo网卡接口,所以,抓取本地数据的网络接口都是lo网卡
   * 命令为 `tcpdump -i lo tcp port 80 -A`

### 远程debug调试
*  通过远程debug调试远程来查看代码执行的逻辑,对于一些出现异常,但是不知道原因的一个很好的解决方式.
   1. 服务端开启tomcat远程调试功能,在 bin/catalina.sh中修改参数配置
      * 增加变量设定 JPDA_ADDRESS=8090 或者 直接修改配置此处的定义即可
   2. 要开启调试,则必须要在CATALINA_OPTS变量定义处,在前面增加 -Xdebug 
      * 此处的命令为 CATALINA_OPTS="-Xdebug $JPDA_OPTS $CATALINA_OPTS" 
   3. 开启tomcat服务,到bin/目录下执行 sh catalina.sh jpda start 
      * 注:若使用sh catalina.sh jpda run,则是前台启动
   4. 客户端开启远程调试,开发工具为idea,在Run里面的run/debug Configuration中新增一个remote类型的Configuration
   5. debugger mode 选择 Attach to remote JVM , Transport选择Socket.
   6. 填入服务端的IP地址或者是域名,并且将catalina.sh 中的端口号填入到remote Configuration中
   7. 备注:任何的Java程序都可以通过在启动时,增加开启这个选项来开启远程调试功能.
      * 例: `java -Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=port -jar yourJar.jar`

### 远程调试命令 
* 服务端开启远程调试服务命令(新版本jdk也可使用老版本开启服务命令)
   * jdk版本1.3或更早: `-Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=9099`
   * jdk版本1.4: `-Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=9099`
   * jdk版本5-8: `-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=9099`
   * jdk版本9+ : `-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:9099`
* 总结:
   1. 要进行远程调试,java程序在启动时必须要开启调试模式
   2. 客户端连接则可以使用通用连接器 `com.sun.jdi.SocketAttach:hostname=<host>,port=<port>`,既可以本地,也可以远程
#### 个人建议
   1. 远程调试适用于开发环境和测试环境,生产环境不要使用
   2. 为了程序安全,选择的端口尽量不要是常用端口,这个端口应该就个人使用

   
   
### 参考  
* [tcpdump的用法](https://www.cnblogs.com/maifengqiang/p/3863168.html)
* [抓包工具的tcpdump的用法说明](https://www.cnblogs.com/f-ck-need-u/p/7064286.html)
* [Java远程调试 -Xdebug参数说明](https://blog.csdn.net/lantian0802/article/details/40299377)
* [tomcat 开启远程调试功能](https://blog.csdn.net/sqiucheng/article/details/78488211)
* [开启tomcat远程调试](http://www.07net01.com/2016/11/1721293.html)
* [tomcat7启用远程DEBUG功能](https://blog.csdn.net/yztezhl/article/details/79026404)