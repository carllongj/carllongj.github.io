# OpenSSH

* SSH(`Secure Shell`)是一种网络安全协议,用于计算机加密传输.SSH只是一种协议,存在很多实现,OpenSSH是其一种开源实现.
* 用法
    1. 代替telnet,用于远程进行登录,`ssh user@host`.
    2. ssh 远程执行命令,`ssh user@host 'ls -l ~/'`.
* SSH认证
    * `密码登录`(原理)
        1. 远程主机收到用户的登录请求,把自己的公钥发送给用户.
        2. 用户使用这个公钥,将登录的密码加密后,发送回来.
        3. 远程主机用自己的私钥,解密登录密码,如果密码正确,就执行登录.
        * 整个过程是安全的,但是存在一个风险(`中间人攻击`)
            * 有人截获了登录请求,然后冒充远程主机,将伪造的公钥发送给用户.
            * 攻击者插在用户与远程主机之间(比如公共的wifi区域),使用伪造的公钥,获取到用户的登录密码
            * 再用该密码登陆远程主机,SSH的安全机制将受到破坏.
        * SSH应对中间人攻击
            * 第一次登录时,ssh会出现提示,无法确定host主机的真实性,只知道其公钥指纹.
                * 公钥指纹就是公钥的一个摘要,可能是md5类型,也可能是其它方便用户对比的公钥摘要.
                * 由于SSH协议的公钥是没有证书(CA)公证的,故需要远程主机将自己的公钥指纹放在一个可认证的地方,用户自行核对.
            * 当用户接受了这个远程主机的公钥后,系统将给出提示,`表示host主机已经得到认可`.
            * `远程主机的公钥指纹被接受`以后,它就会`保存在用户的home目录下的.ssh/konwn_hosts文件`中.下次再连接时,系统会识别其公钥指纹了.
                * `保存的是公钥指纹而不是公钥`,在后面使用的过程中客户端会比对公钥的指纹来确定公钥是否正确.
    * 公钥登录(原理)
        1. 用户需要将自己的`公钥`存储在远程主机上.
        2. 登录时,远程主机会使用其`公钥加密一段随机字符串`并且发送给用户.
        3. 用户`使用自己的私钥对其解密后,再发回来`,远程主机对比这两个字符串,若比对成功,则用户允许登录.

## OpenSSH 中命令说明

* OpenSSH 服务端在安装的时候,默认会在机器的 `/etc/ssh`目录下生成基于RSA,ECDSA等算法的公钥和私钥文件.
* OpenSSH 对用户目录权限(`默认配置下`)
    * 若使用了`ssh`相关的命令,OpenSSH 会在用户的home目录下生成一个`.ssh`隐藏目录,该目录的权限必须为`700`.
    * `.ssh` 目录可能会有一个`authorized_keys`文件,该文件用来给ssh用作公钥登录的验证文件.
        * 若是手动创建该文件的,其权限必须要为`600`,否则`sshd将拒绝使用该文件作为公钥登录的验证文件`.

### ssh-keyscan

* 用来获取 `ssh` 的公钥.
* 格式 `ssh-keyscan [options] <host|address_list>`
    * `options`
        * `-p [port]`, 指定访问的ssh端口号,缺省则为22
        * `-t [type]`, 指定从主机扫描的算法类型,可选`rsa1(第一版rsa)`,`dsa`,`ecdsa`,`ed25519`,`rsa(第二版rsa)`.多个值使用逗号分隔,即表示获取多个类型的公钥
        * `-f [file]`, 用来指定一个文件用作机器列表代替标准输入.

### ssh-keygen

* 用来`生成OpenSSH中的密钥对`.
* 格式 `ssh-keygen [options]`
    * `options`
        * `-b [bits]`, 生成的密钥长度,最小为768,默认为2048.
        * `-t [type]`, 指定生成的密钥对的算法类型,可选`rsa1(第一版rsa)`,`dsa`,`ecdsa`,`ed25519`,`rsa(第二版rsa)`
        * `-C [comments]`, 提供一个注释,不参与加解密运算.
        * `-f [filename]`. 指定生成的公私钥的文件路径,公钥会带有`.pub`后缀作为文件名.缺省为 `~/.ssh/id_rsa`
        * `-l`, 一般配合 `-f` 使用某个公钥文件,展示该公钥文件的指纹.
* 生成密钥对时,若给私钥指定了密码,`使用私钥时也需要该密码`.

### ssh-copy-id

* 用来将`本地的public-key拷贝到远程的需要授权公钥登录的机器`上,是客户端执行该命令.
* 格式 `ssh-copy-id [options] [username@]<host>`
    * `options`
        * `-i [iden_file]`, 用来指定拷贝的公钥文件路径.
        * `-p [port]`, 指定ssh端口号.
        * `-n`, 测试运行,查看运行后的效果,不会正真执行拷贝公钥.

### ssh

* 开启一个OpenSSH 的SSH客户端,用以远程登录.
* 格式 `ssh [options] [user@]host [command]`
    * `options`
        * `-l [login_name]`, 用来指定登录的用户名.若不指定,且主机名称也没有指定,默认与当前执行该命令的用户名相同.
        * `-p [port]`, 用来指定ssh的端口号,缺省为22.
        * `-F [conf_file]`, 用来指定一个另类的用户配置文件,配置连接的信息.缺省为~/.ssh/config.
        * `-i [iden_file]`
            * 读取一个指定的私钥文件用以公钥认证,ssh2版本中缺省使用 `~/.ssh/id_dsa` `~/.ssh/id_ecdsa` `~/.ssh/id_ed25519` `~/.ssh/id_rsa`.
                * 若`文件名称不默认相同`,则必须要通过 `-i` 选项来`指定文件`,可以使用多个 `-i` 选项选择私钥.
        * [command], 执行命令的内容,若带有了command参数,客户端将`不会进入到交互式界面`.而是执行命令后返回结果退出.
    * `config格式文件`
        * 解决需要连接到多个远程系统,并且所有远程的IP地址,用户名,端口,连接选项都不同时的情况下执行连接命令.
        * 注释内容使用 `#` 来表示其后的内容属于注释.
        * 文件名默认为 `~/.ssh/config`,并且可以通过 `-F` 选项重新选择文件.
        * 文件格式
            ```
                Host hostname
                    Ssh_Option_Key Value
                    ...
                
                Host hostname1
                    Ssh_Option_Key Value
                    ...
            ```
            * 该格式文件的每一部分称为一节,每一节都是 `Host` 指令开头.
                * Host `<hostName>` (`hostName 可任意名称,也可包含通配符`,在执行`ssh`命令时).
            * 一节的`配置主要是配置 SSH_OPTION_KEY 的配置属性`.
            * 基本配置示例
                * 如登录指令 `ssh carl@dev.example.com -p 2333`
                * 简化该登录指令,并提供相同的连接选项到服务器,只需要键入命令`ssh dev`即可连接.以下配置加入`~/.ssh/config`文件.
                    ```
                        Host dev
                            HostName dev.example.com
                            User carl
                            Port 2333
                    ```
                    * 常用的 `Ssh_Option_Key`还有 `IdentityFile /path/file`
            * 共享配置示例
                * 同linux命令行的通配符一样,可以在配置文件中使用通配符 `* ? !(取反,不匹配)` 来进行通配.
                    * `*` 与shell中的同含义,表示多个单词的`通配符`.
                    * `?` 与shell中的同含义,表示单个单词的`通配符`.
                    * `!` 则表示取反,不匹配.
                * 如配置项
                    ```
                        Host *ell
                            user oberyn

                        Host * !martell
                            LogLevel INFO

                        Host *
                            User root
                    ```
                    * 在执行 `ssh` 命令时,名称不允许使用通配符,只是会根据名称来匹配对应的SSH_Option配置
                    * 遇到多个通配符时,按照`最大长度通配规则`来匹配对应的SSH_OPTION_KEY.
                        * 即 `Host l_*` 和 `Host * `存在相同的SSH_OPTION,若通过 `ssh l_b`将优先`Host l_*`中的相同属性.
* ssh 端口转发
    * 本地端口转发(执行完成后将`本机监听一个端口`进行转发).
        * `转发的地址必须是当前主机能够进行访问的地址`,即`转发是访问本机地址转发到另一个本机可访问地址`.
        * `ssh -CfNg -L [bind_address:]<lport>:forwarding_host:<tport> <user>@<remote_host>`
            * `-C` 用于压缩转发时的内容.
            * `-f` 将ssh启动的端口转发的进程放到后台执行.
            * `-N` 不执行命令,在`端口转发时该选项有用`.
            * `-g` 允许所有的`远程主机`连接当前本地转发端口.
            * `-L [bind_address:]<lport>:forwarding_host:<tport>` 指定的本地端口转发字符串,该串为 `-L` 选项的参数.
                * `bind_address` 表示只允许一台主机进行连接,若没有给出该值或者值为`*:`,表示监听所有的所有主机.
                * `lport` 表示本地监听的端口.
                * `forwarding_host` 表示一个远程主机地址.
                * `tport` 表示本地的转发到的目标端口.
            * `<user>@<remote_host>` 表示登录的主机地址(`remote_host`与 `-L中forwarding_host`可以不同),`lport`若小于1024,则必须要使用root用户.
        * 原理剖析
            * 当本地端口转发命令执行后(即在`windows`上执行该条命令,这`会在windows机器上启动端口转发`),ssh会监听当前主机指定的`lport`上的连接.
            * 一旦有连接被监听到,ssh会在启动一个`socket客户端`去连接`forwarding_host:tport`指定的端口.
            * 获取到远程连接发送的数据后,`SSH Server`原样(若有`-C`选项,`数据会被压缩`)将其写入到`socket客户端`,并发送(`此时进行解压缩`)到`tport`.
    * 远程端口转发(执行完成后将在`远程主机建立一个监听端口`进行转发,`远程主机`是最后的`<user>@<remote_host>`决定).
        * `转发的地址必须是发起SSH连接的客户端可以访问`的,并且时`通过访问接收SSH连接的服务端来转发到该地址`.
        * `ssh -CfNg -R [bind_address:]<lport>:forwarding_host:<tport> <user>@<remote_host>`
            * `-C` 用于压缩转发时内容.
            * `-f` 将ssh启动的端口转发的进程放到后台执行.
            * `-N` 不执行命令,在`端口转发时该选项有用`.
            * `-g` 允许所有的`远程主机`连接当前本地转发端口.
            * `-R [bind_address:]<lport>:forwarding_host:<tport>` 指定的远程端口转发字符串,该串为 `-R` 的选项参数.
                * `bind_address` 表示只允许一台主机进行连接,若`没有给出该值`或者值为`*:`,表示监听所有的所有主机.
                * `lport` 表示远程主机监听的端口.
                * `forwarding_host` 表示一个远程的主机地址,当前地址为`执行该命令`的机器`可以访问的IP地址`.
                * `tport` 表示远程转发到主机的对应的端口,为`remote_host主机的端口`.
            * `<user>@<remote_host>` 表示登录的主机地址(`remote_host`与 `-L中forwarding_host`可以不同),`lport`若小于1024,则必须要使用root用户.
        * 远程端口转发默认是`只监听了本地回环请求`(即只能通过`127.0.0.1`访问),开启全局网络接口监听,需修改 `/etc/ssh/sshd_config` 将`GatewayPorts` 设置为 `yes`.
        * 原理剖析
            * 当远程端口命令执行后(在远程服务端 `user@remote_host` 上启动一个监听端口),端口的地址为 `lport` 指定的端口
            * 客户端访问`SSH Server`端的`lport`端口,`ssh`服务端将访问到指定的 `forwarding_host:tport` 指定的地址.
            * `SSH Server`和`SSH Client`新建一个连接,将访问`SSH Server:lport`转发到由`SSH Client`去访问的`forward_host:tport`.