# FTP
## vsftpd 
### 安装
* 执行对应的安装命令
    * `yum install -y vsftpd`
* 对应的配置文件在 `/etc/vsftpd/` 目录下
    * `ftpusers` 该文件用于配置哪一些`本地用户名`不被允许登陆
    * `user_list` 该文件是否生效取决于 `userlist_enable` 配置项,该配置项默认为`NO`,可通过 `man vsftpd.conf`查看`所有默认配置项`.
    * `vsftpd.conf` 该文件用于配置`vsftpd`服务,核心配置文件.
### 配置
* vsftpd 的服务配置通过 `vsftpd.conf` 配置文件来进行配置
* 配置说明

| prop               |  value        | description                              |
|:------------------:|:-------------:|:----------------------------------------:|
| anonymous_enable   | `YES`/`NO`    | 是否允许匿名登录                          |    
| local_enable       | `YES`/`NO`    | 是否允许本机系统用户登录                   |
| write_enable       | `YES`/`NO`    | 是否允许FTP写命令,上传文件                 |
| anon_upload_enable | `YES`/`NO`    | 是否允许匿名用户上传文件                   |
| chroot_local_user  | `YES`/`NO`    | 是否将用户限制在主目录,防止用户任意切换目录  | 
| chroot_list_enable | `YES`/`NO`    | 是否启用限制用户的名单列表                 |
| chroot_list_file   | `有效目录`     | 用户列表,作用与`chroot`两个配置项组合相关   |
| local_root         | `有效目录`     | 系统用户登录后的根路径                     |
| anon_root          | `有效目录`     | 匿名用户登录后的根路径                     |
| user_config_dir    | `有效目录`     | 用户单独配置文件存放路径                   |

*  chroot 会将对应的ftp路径设置为根路径,`ftp用户`将不被允许切换到该根目录以上的目录
    * 用户对于该目录具有最高权限,故不应该将此目录设置的过高,能够访问对应的系统文件.
* `local_root` 可以配置系统用户登录后的根路径,一旦该选项配置,则所有的用户共享同一个根目录.
* 用户单独配置根路径.
    * 通过 `user_config_dir` 指定配置路径,该路径下的文件可以配置用户对应的根路径
    * 其中,用户名对应文件名称,文件中的内容进行配置 `local_root` 对应路径地址.
### FTP 中的主动模式和被动模式
* FTP 中的两个连接
    * FTP 中会存在两个连接,一个用于传送FTP命令,如`删除文件`,`重命名文件`,`下载文件`,`获取目录列表`,`获取文件信息`.真正进行`上传`和`下载`时,会重新建立一个连接进行传输文件
    * 默认情况下,服务器21端口作为命令端口,20端口为数据端口.
* 主动模式 (PORT 模式)
    * 主动模式,客户端会开启`端口N`和`N+1`(`这两个端口不一定是连续的,可能是相近的两个`)两个端口,`N`表示客户端的命令端口,`N+1`为客户端的数据端口.
    * 在控制连接建立成功后,服务端会使用数据端口20,主动连接客户端`N+1端口`以建立`数据连接`,这是FTP主动模式建立连接过程.
    * 服务器端只需要开启 `21端口`(`控制连接`)的准入和`20端口`(`数据连接`)的准出,客户端由于数据连接的准入端口必须要开启,数据才能够正常传输.
* 被动模式
    * `控制连接`开启成功后,发送 `PASV` 命令,告诉服务器使用`被动模式`,服务器端将开启一个`数据端口P`,通过`PORT命令`将`P端口`告诉客户端.
    * `客户端的某一个端口(N+1)`将会去连接服务器端的`端口P`,建立`数据连接`.
    * `被动模式`由于服务端开启数据连接时,部分`端口P`由于准入规则,就可能被系统防火墙阻拦.
## sftp 配置 
* `SFTP` 为 `SSH` 的一个组件,SSH内部包含了 SFTP的安全文件传输子系统.
    * `SFTP`本身没有单独的守护进程,它必须使用`sshd守护进程`(端口号默认为`22`)来完成对应的连接命令操作.
    * 由于配置权限添加的配置项 `ChrootDirectory` 来完成,故ssh版本必须要`4.8p1`以上.
* 配置
    1. 创建对应的sftp组和sftp用户,创建一个 配置权限的 `chroot` 目录,用户名指定密码(`组名称`任意,`用户名称`任意)
        * `groupadd sftp`
        * `useradd -g sftp -s /sbin/nologin sftp`.
        * `mkdir /opt/soft/sftp`
        * `passwd sftp`
    2. 对 `sftp` 以及 `组和用户`授权.
        * `chown root:sftp /opt/soft/sftp`
        * `chmod -R 755 /opt/soft/sftp`
    3. 编辑 `sshd_config` 配置文件,添加如下`配置项`
        * `Subsystem sftp internal-sftp`
            * 使用 `ssh` 自带的sftp.
        * `Match Group sftp`
            * 匹配对应的组.
        * `ChrootDirectory /opt/soft/sftp` 
            * 设置属于sftp的用户访问的根文件夹.
        * `ForceCommand internal-sftp`
        * `AllowTcpForwarding no`
        * `X11Forwarding no`
    4. 连接 `sftp`
        * `sftp sftp@host`
* `Q & A`
    * 在 sftp 目录下上传文件出现 Permission Denied.
        * 由于 `sftp` 根目录的`权限不允许写入`,故需要在`根目录下新建一个目录,授予可写入权限`,并且只能上传允许写入的目录. 